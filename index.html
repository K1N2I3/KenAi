<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>KenAi</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="minimal-fix.js"></script>
    <!-- 添加触摸事件最佳实践 -->
    <script>
        // 阻止双击缩放
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // 防止缩放
        document.addEventListener('gesturestart', function(event) {
            event.preventDefault();
        }, { passive: false });
        
        // 修复300ms点击延迟
        document.addEventListener('touchend', function(e) {
            if (e.target.tagName.toLowerCase() === 'button' || 
                e.target.closest('button') ||
                e.target.classList.contains('language-select-header') ||
                e.target.classList.contains('model-select-header') ||
                e.target.classList.contains('language-option') ||
                e.target.classList.contains('model-option')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- 添加内联样式 -->
    <style>
        /* 确保欢迎消息在发送消息后消失 */
        .hide-welcome #welcomeMessage {
            display: none !important;
        }
        
        /* 修复新对话问题 */
        .chat-item {
            position: relative;
            z-index: 1;
        }
        
        /* 确保对话项可点击 */
        .chat-item-container {
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- 主应用容器 -->
    <div id="appContainer" class="container">
        <!-- 主题切换效果容器 -->
        <div class="theme-transition-effect" id="themeTransitionEffect"></div>
        
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="toggle-sidebar-btn" id="toggleSidebarBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <div class="logo-icon">K</div>
                    <div class="logo-text">KenAi</div>
                </div>
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i> 开启新对话
            </button>
            
            <div class="chat-history-header">
                今天
                <button id="clearAllChats" class="clear-all-btn" title="清空所有聊天">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- 历史对话将在这里显示 -->
            </div>
            
            <div class="sidebar-footer">
                <button class="settings-btn" id="settingsBtn">
                    <i class="fas fa-cog"></i> <span id="settingsText">设置</span>
                </button>
                <div class="app-version" id="appVersion">KenAi v1.1</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-logo">
                        <div class="welcome-icon">K</div>
                    </div>
                    <h2>我是 KenAi，很高兴见到你！</h2>
                    <p>我可以帮你写代码、读文件、写作各种创意内容，请把你的任务交给我吧～</p>
                    <div class="example-prompts">
                        <h3>你可以尝试问我：</h3>
                        <div class="prompt-buttons">
                            <button class="prompt-btn">解释量子计算的基本原理</button>
                            <button class="prompt-btn">帮我写一个简单的Python爬虫</button>
                            <button class="prompt-btn">推荐几本科幻小说</button>
                            <button class="prompt-btn">如何提高英语口语水平</button>
                        </div>
                    </div>
                </div>
                <!-- 聊天消息将在这里显示 -->
            </div>
            
            <div class="input-container">
                <textarea id="userInput" placeholder="给 KenAi 发送消息" rows="1"></textarea>
                <button id="sendBtn" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="settingsTitle">设置</h2>
            <div class="settings-form">
                <div class="form-group">
                    <label for="apiKey" id="apiKeyLabel">KenAi API 密钥</label>
                    <input type="password" id="apiKey" value="sk-9e6382d54ac645f691bc55191e7ac0e2" readonly>
                </div>
                <div class="form-group">
                    <label for="modelSelect" id="modelSelectLabel">模型选择</label>
                    <div class="select-container">
                        <select id="modelSelect">
                            <option value="deepseek-chat">KenAi 通用模型</option>
                            <option value="deepseek-coder">KenAi 编程模型</option>
                            <option value="deepseek-reasoner">KenAi 推理模型</option>
                        </select>
                    </div>
                </div>
                <!-- 隐藏 API Base URL 设置 -->
                <div class="form-group" style="display: none;">
                    <label for="apiBaseUrl" id="apiBaseUrlLabel">API 基础 URL</label>
                    <input type="text" id="apiBaseUrl" value="https://api.deepseek.com/v1" placeholder="API 基础 URL">
                    <small id="apiBaseUrlHint">默认使用 KenAi API: https://api.deepseek.com/v1</small>
                </div>
                <div class="form-group">
                    <label for="languageSelect" id="languageSelectLabel">语言 / Language</label>
                    <div class="select-container">
                        <select id="languageSelect">
                            <option value="zh">中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="darkModeSwitch" id="darkModeLabel">Dark Mode</label>
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="darkModeSwitch">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-note" id="settingsNote">所有设置更改会自动保存</div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    
    <!-- iPad触摸事件修复脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('iPad触摸事件修复脚本已加载');
            
            // 直接处理所有按钮
            setTimeout(function() {
                const allButtons = document.querySelectorAll('button');
                console.log('找到按钮数量:', allButtons.length);
                
                allButtons.forEach(function(btn) {
                    // 移除现有事件
                    btn.removeEventListener('click', btn.clickHandler);
                    
                    // 添加新的点击处理函数
                    btn.clickHandler = function(e) {
                        console.log('按钮被点击:', this.id || this.className);
                        
                        // 触发特定按钮的操作
                        if (this.id === 'sendBtn') {
                            console.log('触发发送按钮');
                            if (window.sendMessage) window.sendMessage();
                        } else if (this.id === 'newChatBtn') {
                            console.log('触发新对话按钮');
                            if (window.createNewChat) window.createNewChat();
                        } else if (this.id === 'settingsBtn') {
                            console.log('触发设置按钮');
                            if (window.openSettings) window.openSettings();
                        } else if (this.id === 'clearAllChats') {
                            console.log('触发清空对话按钮');
                            if (window.confirmClearAllChats) window.confirmClearAllChats();
                        } else if (this.classList.contains('prompt-btn')) {
                            console.log('触发示例提示按钮');
                            const promptText = this.textContent.trim();
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                userInput.value = promptText;
                                userInput.style.height = 'auto';
                                userInput.style.height = userInput.scrollHeight + 'px';
                                if (window.sendMessage) window.sendMessage();
                            }
                        } else if (this.classList.contains('delete-chat-btn')) {
                            console.log('触发删除对话按钮');
                            const chatId = this.closest('.chat-item').getAttribute('data-id');
                            if (chatId && window.confirmDeleteChat) window.confirmDeleteChat(chatId);
                        }
                    };
                    
                    // 使用事件捕获来确保事件首先被处理
                    btn.addEventListener('click', btn.clickHandler, {capture: true});
                    
                    // 添加触摸事件
                    btn.addEventListener('touchstart', function(e) {
                        console.log('按钮触摸开始:', this.id || this.className);
                        this.classList.add('touch-active');
                    }, {passive: false});
                    
                    btn.addEventListener('touchend', function(e) {
                        console.log('按钮触摸结束:', this.id || this.className);
                        this.classList.remove('touch-active');
                        e.preventDefault();
                        
                        // 主动触发点击事件
                        if (this.clickHandler) {
                            this.clickHandler(e);
                        }
                    }, {passive: false});
                });
                
                // 暴露函数到全局作用域，使其可访问
                window.sendMessage = window.sendMessage || function() {
                    console.log('尝试执行sendMessage函数');
                    const event = new Event('send-message');
                    document.dispatchEvent(event);
                };
                
                window.createNewChat = window.createNewChat || function() {
                    console.log('尝试执行createNewChat函数');
                    const event = new Event('create-new-chat');
                    document.dispatchEvent(event);
                };
                
                window.openSettings = window.openSettings || function() {
                    console.log('尝试执行openSettings函数');
                    const settingsModal = document.getElementById('settingsModal');
                    if (settingsModal) settingsModal.style.display = 'block';
                };
                
                document.addEventListener('send-message', function() {
                    const sendBtnClickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    const sendBtn = document.getElementById('sendBtn');
                    if (sendBtn) sendBtn.dispatchEvent(sendBtnClickEvent);
                });
                
                document.addEventListener('create-new-chat', function() {
                    const newChatBtnClickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    const newChatBtn = document.getElementById('newChatBtn');
                    if (newChatBtn) newChatBtn.dispatchEvent(newChatBtnClickEvent);
                });
                
                // 为动态添加的元素添加触摸事件
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                            for (let i = 0; i < mutation.addedNodes.length; i++) {
                                const node = mutation.addedNodes[i];
                                if (node.nodeType === 1) { // 元素节点
                                    const buttons = node.querySelectorAll('button');
                                    if (buttons.length > 0) {
                                        console.log('发现新添加的按钮:', buttons.length);
                                        buttons.forEach(function(btn) {
                                            // 为新按钮添加触摸事件
                                            btn.addEventListener('touchstart', function(e) {
                                                console.log('新按钮触摸开始:', this.id || this.className);
                                                this.classList.add('touch-active');
                                            }, {passive: false});
                                            
                                            btn.addEventListener('touchend', function(e) {
                                                console.log('新按钮触摸结束:', this.id || this.className);
                                                this.classList.remove('touch-active');
                                                e.preventDefault();
                                                
                                                // 模拟点击事件
                                                const clickEvent = new MouseEvent('click', {
                                                    bubbles: true,
                                                    cancelable: true,
                                                    view: window
                                                });
                                                this.dispatchEvent(clickEvent);
                                            }, {passive: false});
                                        });
                                    }
                                }
                            }
                        }
                    });
                });
                
                // 监听DOM变化
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                
            }, 1000); // 延迟1秒确保页面完全加载
        });
    </script>
</body>
</html> 